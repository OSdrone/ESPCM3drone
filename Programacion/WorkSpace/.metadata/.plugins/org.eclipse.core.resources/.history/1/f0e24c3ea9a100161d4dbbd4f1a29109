/*
 * AHRS.c
 *
 *  Created on: 3 de nov. de 2016
 *      Author: DTUser
 */

#include "AHRS.h"

q15_t Compensacion_Sensor_magnetico(q15_t Roll, q15_t Pitch, int16_t VectorMagnetico[3]){
	q31_t SenRoll = 0;
	q31_t CosRoll = 0;
	q31_t SenPitch = 0;
	q31_t CosPitch = 0;

	q31_t MagX = 0;
	q31_t MagY = 0;

	arm_sin_cos_q31(Roll, &SenRoll, &CosRoll);
	arm_sin_cos_q31(Pitch, &SenPitch, &CosPitch);

	//Pasamos a q15
	SenRoll= SenRoll>>16;
	CosRoll= CosRoll>>16;
	SenPitch= SenPitch>>16;
	CosPitch= CosPitch>>16;

	MagY = ((CosRoll*VectorMagnetico[1] - SenRoll*VectorMagnetico[2])>>16);
	MagX = ((( (CosPitch*VectorMagnetico[0] + SenRoll*VectorMagnetico[1]) +
			 (CosRoll*VectorMagnetico[2]) )>>15) * SenPitch);

	return (q15_t)(32767 * atan2(-MagY, MagX));
}
