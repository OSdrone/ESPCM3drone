/*
 * ServidoresVariables.c
 *
 *  Created on: 12 de oct. de 2016
 *      Author: Ruben
 */

#include "ServidoresVariables.h"

/*  MUTEX  */
osMutexId MutexLecturas9DOFIMU;
osMutexId MutexVariablesEstado;
osMutexId MutexAHRS;

/*  VARIABLES ALMACENADAS  */

static tpLecturas9DOFIMU Lecturas9DOFIMUAlmacenadas;
static q15_t VariablesEstadoAlmacenadas[NUM_VAR_ESTADO];
static tpAHRS AHRSAlmacenado;

void IniciarServidoresVariables(){
	MutexVariablesEstado = xSemaphoreCreateMutex();
	MutexAHRS = xSemaphoreCreateMutex();
	MutexLecturas9DOFIMU = xSemaphoreCreateMutex();
}

void LeerVariablesEstado_Q16(q15_t VariablesEstado[NUM_VAR_ESTADO]){

	xSemaphoreTake(MutexVariablesEstado, portMAX_DELAY);
	memcpy(VariablesEstado, VariablesEstadoAlmacenadas, sizeof(VariablesEstadoAlmacenadas));
	xSemaphoreGive(MutexVariablesEstado);

}

void EscribirVariablesEstado_Q16(q15_t VariablesEstado[NUM_VAR_ESTADO]){

	xSemaphoreTake(MutexVariablesEstado, portMAX_DELAY);
	memcpy(VariablesEstadoAlmacenadas, VariablesEstado, sizeof(VariablesEstadoAlmacenadas));
	xSemaphoreGive(MutexVariablesEstado);
}

void LeerLecturasIMU9DOF(tpLecturas9DOFIMU* Lecturas9DOFIMU){

	xSemaphoreTake(MutexLecturas9DOFIMU, portMAX_DELAY);
	memcpy(Lecturas9DOFIMU, &Lecturas9DOFIMUAlmacenadas, sizeof(Lecturas9DOFIMUAlmacenadas));
	xSemaphoreGive(MutexLecturas9DOFIMU);
}

void EscribirLecturasIMU(tpLecturasIMU* LecturasIMU){

	xSemaphoreTake(MutexLecturas9DOFIMU, portMAX_DELAY);

	Lecturas9DOFIMUAlmacenadas.Valor.x_acel = LecturasIMU->Valor.x_acel;
	Lecturas9DOFIMUAlmacenadas.Valor.y_acel = LecturasIMU->Valor.y_acel;
	Lecturas9DOFIMUAlmacenadas.Valor.z_acel = LecturasIMU->Valor.z_acel;

	Lecturas9DOFIMUAlmacenadas.Valor.temp = LecturasIMU->Valor.temp;

	Lecturas9DOFIMUAlmacenadas.Valor.x_vel = LecturasIMU->Valor.x_vel;
	Lecturas9DOFIMUAlmacenadas.Valor.y_vel = LecturasIMU->Valor.y_vel;
	Lecturas9DOFIMUAlmacenadas.Valor.z_vel = LecturasIMU->Valor.z_vel;

	xSemaphoreGive(MutexLecturas9DOFIMU);
}

void EscribirLecturasBrujulas(tpLecturasBrujula* LecturasBrujula){

	xSemaphoreTake(MutexLecturas9DOFIMU, portMAX_DELAY);

	Lecturas9DOFIMUAlmacenadas.Valor.x_mag = LecturasBrujula->Valor.x_mag;
	Lecturas9DOFIMUAlmacenadas.Valor.y_mag = LecturasBrujula->Valor.y_mag;
	Lecturas9DOFIMUAlmacenadas.Valor.z_mag = LecturasBrujula->Valor.z_mag;

	xSemaphoreGive(MutexLecturas9DOFIMU);
}


void LeerVariableAHRS(tpAHRS* AHRS){
	xSemaphoreTake(MutexAHRS, portMAX_DELAY);
	memcpy(AHRS, &AHRSAlmacenado, sizeof(AHRSAlmacenado));
	xSemaphoreGive(MutexAHRS);
}

void EscribirVariableAHRS(tpAHRS* AHRS){
	xSemaphoreTake(MutexAHRS, portMAX_DELAY);
	memcpy(&AHRSAlmacenado, AHRS, sizeof(AHRSAlmacenado));
	xSemaphoreGive(MutexAHRS);
}

void LeerRollPitchYaw(q15_t Roll, q15_t Pitch, q15_t Yaw){
	xSemaphoreTake(MutexAHRS, portMAX_DELAY);
	Roll = AHRSAlmacenado.Roll;
	Pitch = AHRSAlmacenado.Pitch;
	Yaw = AHRSAlmacenado.Yaw;
	xSemaphoreGive(MutexAHRS);
}
