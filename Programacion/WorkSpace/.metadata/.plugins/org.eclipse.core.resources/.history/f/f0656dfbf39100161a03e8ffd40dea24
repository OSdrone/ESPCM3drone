/*
 * FuncionAHRS.c
 *
 *  Created on: 13 de oct. de 2016
 *      Author: DTUser
 */

#include "Funciones_RTOS.h"
#include "../AHRS.h"
#include "../ServidoresVariables.h"

void AHRS_TASK_FCN(void const * argument){

	tpAHRS AHRS;
	uint8_t i = 0;
	//Variables Filtradas
	int16_t Lectura_Filtrada_Vel[3];
	int16_t Lectura_Filtrada_Acel[3];
	int16_t Lectura_Filtrada_Mag[3];

	//TODO Usar memoria dinamica para ni gastar tanta RAM
	int16_t Lectura_Acel_X[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Acel_Y[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Acel_Z[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Gyro_X[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Gyro_Y[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Gyro_Z[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Mag_X[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Mag_Y[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Mag_Z[NUM_ELEMENTOS_BUFFER_IMU];
	//int16_t Lectura_Temp[NUM_ELEMENTOS_BUFFER_IMU];
	int16_t Lectura_Temp;

	int16_t Salida_Filtro[NUM_ELEMENTOS_BUFFER_IMU];
	uint8_t DatosLeidosFIFOIMU = 0;

	//TODO Iniciar Parametors
	q15_t EstadoFiltroVel_X[4*NUM_ETAPAS_FILTRO_VEL_ANG*sizeof(q15_t)];
	arm_biquad_casd_df1_inst_q15 Filtro_Vel_X = {NUM_ETAPAS_FILTRO_VEL_ANG, COEF_FILTRO_VEL, EstadoFiltroVel_X, NUM_SHIFT_FILTRO_VEL};
	q15_t EstadoFiltroVel_Y[4*NUM_ETAPAS_FILTRO_VEL_ANG*sizeof(q15_t)];
	arm_biquad_casd_df1_inst_q15 Filtro_Vel_Y = {NUM_ETAPAS_FILTRO_VEL_ANG, COEF_FILTRO_VEL, EstadoFiltroVel_Y, NUM_SHIFT_FILTRO_VEL};
	q15_t EstadoFiltroVel_Z[4*NUM_ETAPAS_FILTRO_VEL_ANG*sizeof(q15_t)];
	arm_biquad_casd_df1_inst_q15 Filtro_Vel_Z = {NUM_ETAPAS_FILTRO_VEL_ANG, COEF_FILTRO_VEL, EstadoFiltroVel_Z, NUM_SHIFT_FILTRO_VEL};

	while(1){
		xSemaphoreTake(AHRS_SMPHRHandle, portMAX_DELAY);

//Lemos los datos de la FIFO que llena el DMA
		LeerDatosIMUFIFO(Lectura_Gyro_X, Lectura_Gyro_Y, Lectura_Gyro_Z,
				Lectura_Acel_X, Lectura_Acel_Y, Lectura_Acel_Z,
				Lectura_Mag_X, Lectura_Mag_Y, Lectura_Mag_Z,
				&Lectura_Temp, &DatosLeidosFIFOIMU);

//Filtramos los datos
		//Eliminamos la componenete continua de la señal
		for(i=0;i<DatosLeidosFIFOIMU;i++){
			Lectura_Gyro_X[i] = (Lectura_Gyro_X[i] - LeerOffsetGyro_X())>>2;
			Lectura_Gyro_Y[i] = (Lectura_Gyro_Y[i] - LeerOffsetGyro_Y())>>2;
			Lectura_Gyro_Z[i] = (Lectura_Gyro_Z[i] - LeerOffsetGyro_Z())>>2;
		}

		arm_biquad_cascade_df1_fast_q15(&Filtro_Vel_X, Lectura_Gyro_X, (q15_t*)Salida_Filtro, (uint32_t)DatosLeidosFIFOIMU);

		//Filtramos las medidas
	}
}

void AHRS_TIMER_FCN(void const * argument){
	xSemaphoreGive(AHRS_SMPHRHandle);
}
